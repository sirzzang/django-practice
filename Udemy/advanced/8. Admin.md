# Setup Django Admin



* update Django Admin so as to manage [custom user model](https://github.com/sirzzang/django-practice/blob/master/Udemy/advanced/7.%20User%20Model.md)

* interface to log in and see:
  * which users have been created, 
  * create users ourselves
  * make changes to existing users



<br>

> *질문*
>
> * :two:의 작업만으로 :one:에서 reverse가 동작한 건가? 어떻게?
> * :three:에서 external module, framework 자체를 테스트할 필요 없다는 의미 다시 볼 것 = POST 관련. 우리가 작성하는 코드만 잘 돌아가는지 보면 된다는 의미였던 듯한데?
> * :three:에서 edit page는 원래 Django에 default로 있는 것인지? 아니면 만든 것인지?
> * :four:에서 add_fieldset이 어떻게 되어 있는지. wide 클래스?

<br>



## :one: test 코드

* add tests: `app/core/tests/test_admin.py`	

  * store all of the admin page unit tests

  ```python
  from django.test import TestCase, Client
  from django.contrib.auth import get_user_model
  from django.urls import reverse
  
  
  class AdminSiteTests(TestCase):
      
      # setup function
      def setUp(self):
          self.client = Client() # self client available
          self.admin_user = get_user_model().objects.create_superuser(
          	email='admin@gmail.com',
          	password='123'
          )
          self.client.force_login(self.admin_user) # admin logged in
          self.user = get_user_model().objects.create_user(
          	email='test@gmail.com',
          	password='test123',
              name='test user name'
          )
      
      def test_users_listed(self):
          '''test that users are listed on user page'''
          url = reverse('admin:core_user_changelist') # reverse helper function
          res = self.client.get(url) # test client GET
          
          # 
          self.assertContains(res, self.user.name)
          self.assertContains(res, self.user.email)
  ```

  * `reverse`: helper function to generate URLs for Django admin page

  * `Client`: test client make test requests to the application in unit tests

  * setup function: setup tests that need to be done before every test in test case class

    * `self.admin_user`: create new admin user
    * `force_login`: make sure new user is logged into our client → client helper function allowing to log a user in with the Django authentification
    * `self.user`: create a regular user that is not authenticated*(=can be used to list in our admin page)*

  * `test_users_listed`: test if the users are listed in Django admin

    * customize Django admin to work with [custom user model](https://github.com/sirzzang/django-practice/blob/master/Udemy/advanced/7.%20User%20Model.md)

      > *참고*: Django default user model
      >
      > * expecting a user name
      > * 강의에서의 custom user model expects email address
      > * `admin.py` 파일에서 custom user model을 지원하도록 수정

    * `reverse` helper function 이용해 url 먼저 생성

      * `core_user_changelist`: Django admin documentation에서 정의한 것으로, list user page를 위한 URL 생성
      * ` reverse` 사용함으로써, 이후 어떤 변화가 발생하면 자동적으로 반영

    * `res`: test client의 URL에 대한 HTTP GET 메소드 response

    * `assertionContains`: Django custom assertion 

      * check if response contains certain item
      * check if HTTP response is HTTP 200
      * check if actual output is rendered and the contents there

* test 진행 시 fail: admin 만들지 않았기 때문에 reverse not found

<Br>

## :two: admin 페이지에 User 모델 추가



 customize Django admin to list custom user model



<br>

* `app/core/tests/admin.py`

  ```python
  from django.contrib import admin
  from django.contrib.auth.admin import UserAdmin as BaseUserAdmin
  
  from core import models
  
  
  class UserAdmin(BaseUserAdmin): # extends BaseUserAdmin
      ordering = ['id']
      list_display = ['email', 'name']
      
  
  admin.site.register(models.User, UserAdmin)
  ```

  * change 
    * default Django user admin
    * change class variables to support custom user admin
  * import
    * `UserAdmin`: 기본으로 사용할 `admin`으로, `BaseUserAdmin`이란 이름으로 import
      * `models`: 사용해야 할 모델 import
  * default `UserAdmin`을 수정해서 만들 `UserAdmin`: extending`BaseUserAdmin`
    * ordering: ID object 
    * display: email, name
  * register by `admin.site.register()`: `User`와 `UserAdmin` 등록

* test 진행: 성공! 테스트 5개로 증가

<br>

## :three: admin 수정: edit page

 few changes to support custom user model, b/c the edit page doesn't work in current state

<br>

* `app/core/tests/test_admin.py`: change 페이지가 제대로 렌더링되는지 확인하는 테스트 추가

  ```python
  from django.test import TestCase, Client
  from django.contrib.auth import get_user_model
  from django.urls import reverse
  
  
  class AdminSiteTests(TestCase):
      
      # setup function
      (...)
      
      # test if the custom user model is listed
      (...)
      
      def test_user_change_page(self):
          '''test that the user edit page works'''
          url = reverse['adin:core_user_change', args=[self.user.id]] # /admin/core/user/(ID)
          res = self.client.get(url) # HTTP GET
          
          self.assertEqual(res.status_code, 200)
      
  ```

  * `url`: `reverse`: create URL. 뒤에 ID는 뭔가 있을 것. `reverse`의 `args` 파라미터가 작동하는 방식 중요
  * assertion: status code가 HTTP 200인지 확인

* test: unknown fields. 아직 user admin field가 customize되지 않았으므로 fail.

<br>

* `app/core/admin.py`: admin에서 필드 추가

  ```python
  from django.contrib import admin
  from django.contrib.auth.admin import UserAdmin as BaseUserAdmin
  from django.utils.translation import gettext as _
  
  from core import models
  
  
  class UserAdmin(BaseUserAdmin):
      ordering = ['id']
      list_display = ['email', 'name']
      fieldsets = [
          (None, {'fields': ('email', 'password')}) # top of the page: No title
          (_('Personal Info'), {'fields': ('name', )}), # personal info
          (
          	_('Permissions'),
              {'fields': ('is_active', 'is_staff', 'is_superuser')}
          ),
          (_('Important dates'), {'fields': ('last_login', )})
      ]
  ```

  * import
    * `gettext`
      * `_`로 import. recommended convention for converting strings to human readable text
      * pass through the translation engine. comfortable when making multiple language setup 
  * add a `fieldsets` class variables: define field sets in change and create page
    * add sections with `()`
    * `None`: when there is no title for the section 
    * field가 하나일 때 뒤에 `,` 필요

* test: 성공!



<br>

## :four: admin 수정: add page

 page for adding new users in the Django admin

<br>

* `app/core/tests/test_admin.py`: add page 렌더링 테스트 추가

  ```python
  from django.test import TestCase, Client
  from django.contrib.auth import get_user_model
  from django.urls import reverse
  
  
  class AdminSiteTests(TestCase):
      
      # setup function
      (...)
      
      # test if the custom user model is listed
      (...)
      
      # test if edit page is rendered
      (...)
      
      def test_create_user_page:
          '''test that the create user page works'''
          url = reverse('admin:core_user_add')
          res = self.client.get(url)
          
          self.assertEqual(res.status_code, 200)        
  ```

  * :three:에서와 비슷하게 client가 user_add URL에 대해 200 response를 받을 수 있는지 확인하는 테스트
  * `core_user_add`: standard URL alias for the add page 

* test 진행: user add 페이지가 없으므로 당연히 fail

<br>

* `app/core/admin.py`: `add field`에 대한 field set class variable 추가

  ```python
  from django.contrib import admin
  from django.contrib.auth.admin import UserAdmin as BaseUserAdmin
  from django.utils.translation import gettext as _
  
  from core import models
  
  
  class UserAdmin(BaseUserAdmin):
  	(...)
      add_fieldsets = (
      	(None, {
              'classes': ('wide', )
              'fields': ('email', 'password1', 'password2')
          }),
      )
  ```

  * Django documentation에 따르면, Django admin은 default로 dd field set을 가지고 있음(*=same as create user page*)
    * 이 default field set을 customize하여 email 주소, password 등을  받도록
    * 최소한의 데이터만 가지고 새로운 user를 create할 수 있도록
    * 이후 또 다른 데이터가 필요하다면 :three:의 edit page를 이용
  * `add_fieldsets`는 documentation에 따라
  * item 자체가 한 개인 경우도 마지막에 `,` 붙여주는 것을 잊지 말아야!

* test 진행: 7개 테스트 모두 성공!





<br>

 이제 Django admin customization 완료.